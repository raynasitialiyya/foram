"use strict";var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var mindatViewer=function(){function e(t){var i=this;_classCallCheck(this,e);var o={el:"mindatV",type:"normal",stereoOutputLeftFirst:0,stereoType:"mono",lastUsedStereoType:"sync",compareType:"slider",anaglyphMergeType:"Optimized+",anaglyphGlasses:"RedCyan",interlacedType:"row",hideDragbars:null,preloadPrevNext:1,img:{},ic:{},mb:{},scalebarScale:0,galleryViews:[],isMobile:!1,isTablet:!1,androidFix:!1,sens:10,li_copyright:"",debug:0,OSDoptions:{showNavigationControl:!1,id:"seadragon",animationTime:.5,constrainDuringPan:!0,maxZoomPixelRatio:3,gestureSettingsTouch:{flickEnabled:!1},imageSmoothingEnabled:!0,showNavigator:!1,visibilityRatio:0}};OpenSeadragon.setImageFormatsSupported({avif:!1,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0});var s=$.extend({},o.OSDoptions,t.OSDoptions);if(this.options=$.extend({},o,t),void 0===this.options.img.childViews&&(this.options.img.childViews=[]),this.options.img.cuhrte=parseInt(this.options.img.cuhrte),this.options.OSDoptions=s,this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,this.el=document.getElementById(this.options.el),this.viewers=[],this.OSDsync={},this.type=this.options.type,this.img=this.options.img,this.gallery2=new MVgallery(this.img.pid,this.options.galleryViews),this.img.galleryC=new MVgallery(this.img.pid,this.options.img.childViews),this.stereoType=$.cookie("stereoType"),this.lastUsedStereoType=$.cookie("lastUsedStereoType"),this.stereoOutputLeftFirst=parseInt($.cookie("stereoOutputLeftFirst")),this.anaglyphMergeType=$.cookie("anaglyphMergeType"),this.anaglyphGlasses=$.cookie("anaglyphGlasses"),this.interlacedType=$.cookie("interlacedType"),this.hideDragbars=parseInt($.cookie("hideDragbars")),this.offsetDragbars=parseInt($.cookie("offsetDragbars")),void 0===this.stereoType&&(this.stereoType=this.options.stereoType),void 0===this.lastUsedStereoType&&(this.lastUsedStereoType=this.options.lastUsedStereoType),isNaN(this.stereoOutputLeftFirst)&&(this.stereoOutputLeftFirst=this.options.stereoOutputLeftFirst),void 0===this.anaglyphMergeType&&(this.anaglyphMergeType=this.options.anaglyphMergeType),void 0===this.anaglyphGlasses&&(this.anaglyphGlasses=this.options.anaglyphGlasses),void 0===this.interlacedType&&(this.interlacedType=this.options.interlacedType),isNaN(this.hideDragbars)&&(this.hideDragbars=this.options.hideDragbars),this.options.isMobile&&null===this.hideDragbars&&(this.hideDragbars=1),(isNaN(this.offsetDragbars)||this.hideDragbars)&&(this.offsetDragbars=0),"stereopair"==this.type&&0==this.stereoOutputLeftFirst){var n=this.img.tileSources[0];this.img.tileSources[0]=this.img.tileSources[1],this.img.tileSources[1]=n}if("stereopair"==this.options.type&&null==this.options.stereoType&&(this.options.stereoType="mono"),"compare"==this.options.type&&null==this.options.compareType&&(this.options.compareType="1x"),this.glev=parseInt("0"+$.cookie("picgs")),this.compareType=this.options.compareType,this.buttondock=[],this.buttonsDimmed=0,this.overlay=1,this.iwidth=0,this.iheight=0,this.rmode=0,this.helpshow=0,this.autoplay=0,this.thisframe=this.options.img.startframe,this.rotateloop=this.options.img.rotateloop,this.framesloaded=0,this.rotateImgBuffer=[],this.sens=this.options.sens,this.zoomenable=1,this.myInterval=0,this.lastsize=0,this.lastimagename=0,this.eventListeners={},this.eventListeners.windowSelectView=0,"compare"==this.type){this.img.tileSources.length<2&&(this.compareType="1x");var a=function(e,t){var i=e.map((function(e,i){return[e,t.indexOf(i)]}));return i.sort((function(e,t){return e[1]-t[1]})),i.map((function(e){return e[0]}))},r=this.img.compareOrders;r[0]=-1;var l=r.map((function(e,t){return[t,e]}));l.sort((function(e,t){return e[1]===t[1]?0:0==e[1]?1:0==t[1]?0:e[1]-t[1]}));var d=l.map((function(e){return e[0]}));this.img.compareNames=a(this.img.compareNames,d),this.img.comparePids=a(this.img.comparePids,d),this.img.tileSources=a(this.img.tileSources,d),this.compareNames=this.img.compareNames,this.compareNames.forEach((function(e,t,o){e&&""!=e||(o[t]="Photo "+i.img.comparePids[t])})),this.tileSourcesSelected=[],this.compareNamesSelected=$.extend({},this.compareNames)}"stereopair"==this.type&&(this.stereoTypeValues=["mono","sync","interlace","anaglyph","halfwidth","halfheight"],this.interlacedTypeValues=["row","column","chessboard"],this.anaglyphMergeTypeValues=["Optimized+","Optimized","Color","Grey","True"],this.anaglyphGlassesValues=["RedCyan","GreenMagenta"]),this.nonOSDzoom={zoom:1,scale:1,ticking:!1,START_X:0,START_Y:0,START_Z:1,LAST_X:0,LAST_Y:0,LAST_D:0,LAST_Z:1,xxx:0,yyy:0,sens:this.options.sens},this.scroll={START_Y2:0,LAST_Y2:0,START_HY2:0,LAST_HY2:0},this.video={ii:0,ii2:0},this.windowPos={x:0,y:0},this.touchHandler=function(e){var t=e.changedTouches[0],i=document.createEvent("MouseEvent");i.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(i),"touchmove"==e.type&&e.preventDefault()},this.touchInit=function(e,t){t.addEventListener("touchstart",i.touchHandler,!0),e.addEventListener("touchmove",i.touchHandler,!0),e.addEventListener("touchend",i.touchHandler,!0),e.addEventListener("touchcancel",i.touchHandler,!0)},this.debounce=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=void 0,o=0;return function(){for(var s=arguments.length,n=Array(s),a=0;a<s;a++)n[a]=arguments[a];clearTimeout(i);var r=Date.now(),l=r-o;l>t?(o=r,e.apply(void 0,n)):i=setTimeout((function(){o=r,e.apply(void 0,n)}),t)}},this.start()}return _createClass(e,[{key:"initMindatOverlayManager",value:function(){var e=this;if(this.img.cuhrte||this.img.annotations&&""!=this.img.annotations){var t={overlays:[]},i=null;if(this.img.annotations){if(t=JSON.parse(this.img.annotations),!this.img.cuhrte&&!t.overlays)return;if(!this.img.cuhrte&&0==t.overlays.length)return;t=JSON.parse(this.img.annotations);var o=this.img.labelTexts||[];t.labelColors&&t.labelColors.length>0&&(i=o.map((function(e){var i=t.labelColors.find((function(t){return t.labelText===e}));return i?i.labelColor:"#7a7a7a"})))}var s={editable:!1,mode:1,container:document.getElementById("photomain"),labelTexts:this.img.labelTexts,cuhrte:this.img.cuhrte};t.overlays.length>0&&(s.overlays=t.overlays),i&&(s.labelColors=i),this.img.overlayManager=new MindatOverlayManager(this.viewers[0],s),$("#menu-annotations-save").on("click",(function(t){$.ajax({url:"/update_photo_ajax_annotations.php",type:"POST",data:{pid:e.img.pid,annotations:e.img.overlayManager.getOverlaysDataJSON(),annotation_texts:e.img.overlayManager.getOverlaysTexts(" --- ")},success:function(e){},error:function(e,t,i){}})})),$(".navigator").css({"z-index":"25"}),$("#titlebar").addClass("annotationsmenu"),$("#menu-annotations-edit").on("click",(function(t){e.overlay&&e.toggleoverlay(!0)})),$("#menu-annotations-save").on("click",(function(t){e.overlay||e.toggleoverlay(!0)}))}}},{key:"start",value:function(){var e=this;this.IOSfixes(),this.template(),this.template_buttondock(),this.mainphotoload(),$(window).ready((function(){e.arrowsShowHide()})),"rotation"!=this.type&&"video"!=this.type&&(this.zoomenable=!0,$("#ctrlimg").hide()),"video"==this.type&&($("#ctrlimg").replaceWith((function(e,t){return $("<div/>",{id:"ctrlimg",width:this.width,height:this.height})})),this.nonOSDzoom.sens=this.nonOSDzoom.sens/8,$("#ctrlimg").append($("#mainphoto")),$("#ctrlimg").append($("#mvideo")),$("#ctrlimg").css("opacity","1"),$("#mvideo").css("z-index","1")),"rotation"==this.type&&$("#mainphoto").css("opacity",1),"normal"==this.type&&(this.initViewersNormal(),this.initScalebar(),this.initMindatOverlayManager()),"stereopair"==this.type&&"mono"==this.stereoType&&(this.overlay||this.toggleoverlay(!0),this.initViewersStereoMono(),this.initStereo3Dmenu(),this.initScalebar()),clearInterval(this.intervalWindowMoved),"stereopair"==this.type&&"interlace"==this.stereoType&&(this.initViewersStereoInterlace(),this.initStereo3Dmenu(),this.intervalWindowMoved=setInterval(this.checkWindowMoved.bind(this),500)),"stereopair"==this.type&&"anaglyph"==this.stereoType&&(this.initViewersStereoAnaglyph(),this.initStereo3Dmenu()),"stereopair"==this.type&&"sync"==this.stereoType&&(this.initStereo3Dmenu(),this.hideDragbars?($(".dragbar").hide(),$(".divider").hide(),this.offsetDragbars=0):this.stereoDragbars=new dragbars(this.offsetDragbars),$(window).ready((function(){e.windowResizeStereo(),e.initViewersStereoSync()}))),"stereopair"==this.type&&"halfwidth"==this.stereoType&&(this.initStereo3Dmenu(),$(window).ready((function(){e.initViewersStereoHalfWidth()}))),"stereopair"==this.type&&"halfwidth"==this.stereoType?this.switchButtonsHalfWidth(!0):this.switchButtonsHalfWidth(!1),"stereopair"==this.type&&"halfheight"==this.stereoType?this.switchButtonsHalfHeight(!0):this.switchButtonsHalfHeight(!1),"stereopair"==this.type&&"halfheight"==this.stereoType&&(this.initStereo3Dmenu(),$(window).ready((function(){e.initViewersStereoHalfHeight()}))),"stereopair"==this.type&&"mono"!=this.stereoType&&this.overlay&&this.toggleoverlay(!0),"compare"==this.type&&"slider"==this.compareType&&(this.initViewersCompareSlider(),this.initCompareMenu(),this.initScalebar(),this.initMindatOverlayManager()),"compare"==this.type&&"slider"!=this.compareType&&(this.initCompareMenu(),this.initScalebar(),$(window).ready((function(){e.windowResizeCompare(),e.initViewersCompareSync()}))),"stereopair"==this.type&&("mono"==this.stereoType&&0==this.stereoOutputLeftFirst?this.initMindatOverlayManager():this.initFakeAnnotationsMenu()),this.attachListeners(),this.attachKeydownListener()}},{key:"initFakeAnnotationsMenu",value:function(){var e=this,t={overlays:[]};if(this.img.annotations&&(t=JSON.parse(this.img.annotations)),0!=t.overlays.length){var i=document.createElement("div");i.id="menu-annotations-f",i.className="menu-annotations",i.style.display="block",i.innerHTML='\n      <div id="menu-annotations-btn-cont"><div class="menu-annotations-h">Annotations</div></div>\n      <div id="menu-annotations-btn2-cont">\n        <button id="menu-annotations-go2d-f" class="menu-annotations-btn2">Go to 2D</button>\n        <button id="menu-annotations-show-f" class="menu-annotations-btn2">Show</button>\n        <button id="menu-annotations-edit-f" class="menu-annotations-btn2">Edit</button>          \n      </div>      \n      ',document.getElementById("photomain").appendChild(i),$(".menu-annotations-btn2").hide(),t.overlays.length>0&&$("#menu-annotations-go2d-f").show(),$("#menu-annotations-go2d-f,#menu-annotations-edit-f,#menu-annotations-show-f").on("click",(function(t){$.cookie("stereoOutputLeftFirst",0,{expires:365}),$.cookie("lastUsedStereoType",e.stereoType,{expires:365}),$.cookie("stereoType","mono",{expires:365}),location.reload(),t.stopPropagation()})),$("#titlebar").addClass("annotationsmenu")}}},{key:"switchMode",value:function(e){var t=this;if(clearInterval(this.intervalWindowMoved),this.stereoDragbars&&(this.offsetDragbars=this.stereoDragbars.getOffset()),this.destroyViewers(),e)this.type=e.type;else switch(e={},this.img.childViews&&!this.img.galleryC&&(this.img.galleryC=new MVgallery(this.img.pid,this.img.childViews)),parseInt(this.img.viewmode)){case 3:if(this.type="stereopair",0==this.stereoOutputLeftFirst){var i=this.img.tileSources[0];this.img.tileSources[0]=this.img.tileSources[1],this.img.tileSources[1]=i}break;case 2:this.type="compare";break;case 1:default:this.type="normal"}if("stereopair"==this.type&&(void 0!==e.stereoType?this.stereoType=e.stereoType:this.stereoType||(this.stereoType=$.cookie("stereoType")),this.template(),"mono"==this.stereoType&&(this.overlay||this.toggleoverlay(!0),this.initViewersStereoMono(),this.initScalebar()),"sync"==this.stereoType&&(this.hideDragbars?($(".dragbar").hide(),$(".divider").hide(),this.offsetDragbars=0):this.stereoDragbars=new dragbars(this.offsetDragbars),this.windowResizeStereo(),this.initViewersStereoSync(),window.onresize=this.debounce((function(){return t.windowResizeStereo()}),300)),"halfheight"==this.stereoType&&(this.initViewersStereoHalfHeight(),window.onresize=this.debounce((function(){return t.windowResizeStereoHalfHeight()}),300)),"halfwidth"==this.stereoType&&(this.initViewersStereoHalfWidth(),window.onresize=this.debounce((function(){return t.windowResizeStereo()}),300)),"anaglyph"==this.stereoType&&this.initViewersStereoAnaglyph(),clearInterval(this.intervalWindowMoved),"interlace"==this.stereoType&&(this.initViewersStereoInterlace(),this.intervalWindowMoved=setInterval(this.checkWindowMoved.bind(this),500)),"mono"!=this.stereoType&&this.toggleoverlay(!0),this.viewers[0].scalebarInstance&&"stereopair"==this.type&&"mono"!=this.stereoType?this.viewers[0].scalebar({location:OpenSeadragon.ScalebarLocation.NONE}):this.initScalebar()),"stereopair"==this.type&&"halfwidth"==this.stereoType?this.switchButtonsHalfWidth(!0):this.switchButtonsHalfWidth(!1),"stereopair"==this.type&&"halfheight"==this.stereoType?this.switchButtonsHalfHeight(!0):this.switchButtonsHalfHeight(!1),"stereopair"==this.type&&$("#menu-annotations").length>0&&($("#menu-annotations").hide(),this.initFakeAnnotationsMenu()),"compare"==this.type&&(this.compareType=e.compareType,this.template(),"slider"==this.compareType?this.initViewersCompareSlider():(this.windowResizeCompare(),this.initViewersCompareSync()),this.initScalebar()),"normal"==this.type&&(this.template(),this.initViewersNormal(),this.initScalebar()),!e.type){$("#titlebar h2").replaceWith(this.img.titlebar_h2),$("#copyrightfloat").html(this.img.copyrightfloat),$("#photoinfoinner").html(this.img.photoinfoinner),this.arrowsShowHide();var o="photo-"+this.img.pid+".html";history.replaceState({},"",o)}}},{key:"destroyViewers",value:function(){this.viewers.forEach((function(e,t){e.destroy()})),this.OSDsync={},this.viewers=[],$("#"+this.options.el).empty()}},{key:"get_window_pos",value:function(e){if("y"==e){if(window.screenY)return window.screenY;if(window.screenTop)return window.screenTop}else{if(window.screenX)return window.screenX;if(window.screenLeft)return window.screenLeft}return 0}},{key:"checkWindowMoved",value:function(){var e=this.get_window_pos("x"),t=this.get_window_pos("y");this.windowPos.x==e&&this.windowPos.y==t||(this.windowPos.x=e,this.windowPos.y=t,this.viewers[0].forceRedraw())}},{key:"arrowsShowHide",value:function(){this.gallery2.prevIndex>=0?$("#clickleft").show():$("#clickleft").hide(),this.gallery2.nextIndex>=0?$("#clickright").show():$("#clickright").hide(),this.img.galleryC.nextIndex>=0?$("#clicknext").show():$("#clicknext").hide(),this.img.galleryC.prevIndex>=0?$("#clickprev").show():$("#clickprev").hide()}},{key:"saveCurrentToGallery",value:function(e){var t=$.extend(!0,{},this.img);t.indexGal=e.currIndex,t.titlebar_h2=$("#titlebar h2")[0].outerHTML,t.copyrightfloat=$("#copyrightfloat").html(),t.photoinfoinner=$("#photoinfoinner").html(),t.infoLoaded=1,e.items[e.currIndex].preloadedImage=t}},{key:"IOSfixes",value:function(){this.isIOS&&($(document.head).append("<style>*{cursor:pointer;-webkit-tap-highlight-color:rgba(0,0,0,0)}</style>"),$(window).on("gesturestart touchmove",(function(e){1!==e.originalEvent.scale&&(e.originalEvent.preventDefault(),document.body.style.transform="scale(1)")})))}},{key:"attachListeners",value:function(){var e=this;$("#showinfo").click((function(t){e.showinfo()})),$("#hideinfo").click((function(t){e.hideinfo()})),$("#clickleft").click((function(t){e.previmgGal2()})),$("#clickright").click((function(t){e.nextimgGal2()})),$("#clickprev").click((function(t){e.previmg()})),$("#clicknext").click((function(t){e.nextimg()})),"sync"==this.stereoType&&(window.onresize=this.debounce((function(){return e.windowResizeStereo()}),300)),"halfheight"==this.stereoType&&(window.onresize=this.debounce((function(){return e.windowResizeStereoHalfHeight()}),300)),"compare"==this.type&&"slider"!=this.compareType&&(window.onresize=this.debounce((function(){return e.windowResizeCompare()}),300));var t={};"video"==this.type&&((t=new Hammer.Manager(document.getElementById("playvideo"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.playvideo()})),(t=new Hammer.Manager(document.getElementById("resetvideo"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.resetvideo()}))),(t=new Hammer.Manager(document.getElementById("helpbutton"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.togglehelp()})),(t=new Hammer.Manager(document.getElementById("helpbox"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.togglehelp()})),"rotation"==this.type&&((t=new Hammer.Manager(document.getElementById("playvideo"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.playRotation()})),(t=new Hammer.Manager(document.getElementById("rotateon"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.framesloaded==e.img.frames&&(e.rmode=1,e.helpshow=1,$("#rotateon").fadeTo(200,1),$("#rotateoff").fadeTo(200,.5),$("#rotatehelp").fadeTo(200,.5))})),(t=new Hammer.Manager(document.getElementById("rotateoff"))).add(new Hammer.Tap({event:"singletap"})),t.on("singletap",(function(t){e.rmode=0,$("#rotateon").fadeTo(200,.5),$("#rotateoff").fadeTo(200,1)})));var i=new Hammer.Manager(document.getElementById("photoinfobox"));i.add(new Hammer.Pan({threshold:10})),i.on("panstart",(function(t){e.scroll.START_Y2=$("#photoinfobox").scrollTop()})).on("panmove",(function(t){e.scroll.LAST_Y2=e.scroll.START_Y2-t.deltaY,$("#photoinfobox").scrollTop(e.scroll.LAST_Y2)}));var o=new Hammer.Manager(document.getElementById("helpbox"));if(o.add(new Hammer.Pan({threshold:10})),o.on("panstart",(function(t){e.scroll.START_HY2=$("#helpbox").scrollTop()})).on("panmove",(function(t){e.scroll.LAST_HY2=e.scroll.START_HY2-t.deltaY,$("#helpbox").scrollTop(e.scroll.LAST_HY2)})),"rotation"==this.type||"video"==this.type){var s=document.getElementById("ctrlimg"),n=new Hammer(s),a=new Hammer.Pan({threshold:10});n.add(a),n.on("panstart",(function(t){t.preventDefault(),e.nonOSDzoom.START_X=e.nonOSDzoom.LAST_X,e.nonOSDzoom.START_Y=e.nonOSDzoom.LAST_Y})).on("panmove",(function(t){if(t.preventDefault(),"rotation"==e.type)if(e.rmode){e.autoplay&&e.stopRotation(),e.helpshow&&($("#rotatehelp").fadeOut(250),e.helpshow=0);var i=t.deltaX;i>e.nonOSDzoom.LAST_D+e.sens&&(e.ffd(0),e.nonOSDzoom.LAST_D=i),i<e.nonOSDzoom.LAST_D-e.sens&&(e.ffd(1),e.nonOSDzoom.LAST_D=i)}else e.nonOSDzoom.LAST_X=e.nonOSDzoom.xxx=e.nonOSDzoom.START_X+t.deltaX/e.nonOSDzoom.scale,e.nonOSDzoom.LAST_Y=e.nonOSDzoom.yyy=e.nonOSDzoom.START_Y+t.deltaY/e.nonOSDzoom.scale;"video"==e.type&&(e.nonOSDzoom.LAST_X=e.nonOSDzoom.xxx=e.nonOSDzoom.START_X+t.deltaX/e.nonOSDzoom.scale,e.nonOSDzoom.LAST_Y=e.nonOSDzoom.yyy=e.nonOSDzoom.START_Y+t.deltaY/e.nonOSDzoom.scale),e.requestUpdate()}));var r=new Hammer.Pinch;n.add(r),n.on("pinchstart",(function(t){t.preventDefault(),e.nonOSDzoom.START_Z=e.nonOSDzoom.LAST_Z})).on("pinchmove",(function(t){if(t.preventDefault(),e.zoomenable){var i=Math.floor(e.img.pixelwidth/e.iwidth);i<6&&(i=6),i>15&&(i=15),e.nonOSDzoom.zoom=e.nonOSDzoom.START_Z*t.scale,e.nonOSDzoom.zoom>i&&(e.nonOSDzoom.zoom=i),e.nonOSDzoom.LAST_Z=e.nonOSDzoom.zoom,e.nonOSDzoom.scale=e.nonOSDzoom.zoom,e.requestUpdate(),"normal"!=e.type&&"video"!=e.type||e.loadimage()}})),s.addEventListener&&(s.addEventListener("mousewheel",this.mouseWheelHandler.bind(this),!1),s.addEventListener("DOMMouseScroll",this.mouseWheelHandler.bind(this),!1))}}},{key:"toggle3dKey",value:function(){if("stereopair"==this.type){var e="mono";"mono"==this.stereoType&&(e=this.lastUsedStereoType),this.switchMode({type:"stereopair",stereoType:e})}}},{key:"attachKeydownListener",value:function(){var e=this;$("BODY").keydown((function(t){var i=1;if($("input, #metext").each((function(){this==document.activeElement&&(i=0)})),i)switch(t.which){case 39:t.shiftKey?e.nextimgGal2():e.nextimg();break;case 37:t.shiftKey?e.previmgGal2():e.previmg();break;case 38:e.showinfo();break;case 40:e.hideinfo();break;case 32:e.toggleoverlay(),"stereopair"!=e.type&&"compare"!=e.type||(e.overlay||e.buttonsDimmed?e.buttonsDimmed&&e.dimButtons(!1):e.dimButtons(!0));break;case 80:"rotation"==e.type&&e.playRotation(),"video"==e.type&&e.playvideo();break;case 188:e.darker();break;case 190:e.lighter();break;case 49:e.fill(0);break;case 50:e.fill(1);break;case 51:e.toggle3dKey();break;case 52:"stereopair"==e.type&&e.universalStereoSwapLR();break;case 53:if("rotation"!=e.type&&"video"!=e.type&&e.viewers[0]){var o=e.viewers[0].viewport.imageToViewportZoom(1);e.viewers[0].viewport.zoomTo(o)}break;case 72:case 191:e.togglehelp();break;case 219:"rotation"==e.type&&(e.helpshow&&$("#rotatehelp").fadeOut(250),e.autoplay&&e.stopRotation(),e.ffd(1)),"stereopair"==e.type&&e.stereoType,e.type;break;case 221:"rotation"==e.type&&(e.helpshow&&$("#rotatehelp").fadeOut(250),e.autoplay&&e.stopRotation(),e.ffd(0)),"stereopair"==e.type&&e.stereoType,e.type}}))}},{key:"chkfullscreen",value:function(){return window.navigator.standalone||document.fullScreenElement&&null!=document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen||!window.screenTop&&!window.screenY?1:0}},{key:"updateTransform",value:function(){var e="scale("+this.nonOSDzoom.scale+","+this.nonOSDzoom.scale+") translate("+this.nonOSDzoom.xxx+"px, "+this.nonOSDzoom.yyy+"px)";if($("#mainphoto").css({webkitTransform:e}).css({mozTransform:e}).css({transform:e}),this.nonOSDzoom.ticking=!1,"video"==this.type){var t=document.getElementById("mainphoto").getBoundingClientRect(),i=Math.floor(t.right-t.left),o=Math.floor(t.bottom-t.top),s=t.left;$("#mvideo").css("top",Math.floor(t.top)).css("left",Math.floor(s)).attr("width",i).attr("height",o).width(i).height(o)}}},{key:"ffd",value:function(e){!this.img.mode&&1==e||this.img.mode&&0==e?(this.thisframe++,this.rotateloop&&this.thisframe>=this.img.frames&&(this.thisframe=0),this.rotateloop||(this.thisframe>=this.img.frames?this.thisframe=this.img.frames-1:this.autoplay&&this.stopvideo())):(this.thisframe--,this.rotateloop?this.thisframe<=0&&(this.thisframe=this.img.frames-1):this.thisframe<=0?this.thisframe=0:this.autoplay&&this.stopvideo()),this.options.isMobile||this.options.isTablet?$("#mainphoto").css("background-position",0-this.thisframe*this.iwidth+"px 0px"):$("#mainphoto").attr("src","rotatephotos/R"+this.thisframe+"_"+this.img.filename)}},{key:"mouseWheelHandler",value:function(e){if(e.preventDefault(),this.zoomenable){var t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),i=Math.floor(this.img.pixelwidth/this.iwidth);i<6&&(i=6),i>15&&(i=15);var o=this.nonOSDzoom.zoom;t>0?o*=1.1:o/=1.1,o>i&&(o=i),o<.3&&(o=.3),this.nonOSDzoom.zoom=o,this.nonOSDzoom.scale=o,this.requestUpdate(),this.img.frames<3&&this.loadimage()}return!1}},{key:"preloadframes",value:function(){var e,t,i=this,o=this.img.frames;if(this.options.isMobile||this.options.isTablet){$("#mainphoto").attr("width",iwidth).attr("height",iheight);var s=new Image;s.onload=function(){$("#mainphoto").replaceWith("<div id='mainphoto' style='width: "+i.iwidth+"px; height: "+i.iheight+"px'></div>"),$("#rotateon").fadeTo(200,1),$("#rotateoff").fadeTo(200,.5),$("#rotatehelp").fadeTo(200,.5),i.helpshow=1,i.rmode=1,i.framesloaded=i.img.frames;var e=i.iwidth*o;i.options.androidfix&&(e*=i.options.androidfix+1),$("#mainphoto").css("background-image","url('rotatephotos/W<?=$this->img->filename?>')").css("background-size",e+"px "+i.iheight+"px")},s.src="rotatephotos/W"+this.img.filename}else{var n=$("#rotateon").width();for($("#rotateprogress").height($("#rotateon").height()),e=0;e<o;e++)t="rotatephotos/R"+e+"_"+this.img.filename,function(e,t){e.onload=function(){if(++i.framesloaded==o)$("#rotateon").fadeTo(200,1),$("#playvideo").fadeTo(200,1),$("#rotateoff").fadeTo(200,.5),$("#rotatehelp").fadeTo(200,.5),i.rmode=1,i.helpshow=1,$("#rotateprogress").width(0);else{var t=i.framesloaded/o*n;$("#rotateprogress").width(t)}document.body.appendChild(e).className="cacheimg"},e.src=t}(this.rotateImgBuffer[e]=new Image,t)}}},{key:"previmg",value:function(){var e=this,t=this.img.galleryC;if(-1!=t.currIndex)if(t.prevPid())t.loadImageInfo(t.prevPid()).then((function(i){e.img=$.extend(!0,{},i),t.gotoPrev(),e.switchMode()}));else{var i=t.currIndex,o=t.items.length;if(i>0){$("#counterCF").html(i--+"/"+o).show();var s=t.items[i].pid;$("BODY").css("cursor","wait"),window.location.href="/photo-"+s+".html"}}}},{key:"nextimg",value:function(){var e=this,t=this.img.galleryC;if(-1!=t.currIndex)if(t.nextPid())t.loadImageInfo(t.nextPid()).then((function(i){e.img=$.extend(!0,{},i),t.gotoNext(),e.switchMode()}));else{var i=t.currIndex,o=t.items.length;if(i<o-1){$("#counterCF").html(1+ ++i+"/"+o).show();var s=t.items[i].pid;$("BODY").css("cursor","wait"),window.location.href="/photo-"+s+".html"}}}},{key:"nextimgGal2",value:function(){var e=this,t=this.gallery2;if(-1!=t.currIndex)if(t.nextPid())t.loadImageInfo(t.nextPid()).then((function(i){e.img=$.extend(!0,{},i),t.gotoNext(),e.switchMode()}));else{var i=t.currIndex;if(i<t.items.length-1){i++,"stereopair"!=this.type||this.stereoType;var o=t.items[i].pid;$("BODY").css("cursor","wait"),window.location.href="/photo-"+o+".html"}}}},{key:"previmgGal2",value:function(){var e=this,t=this.gallery2;if(-1!=t.currIndex)if(t.prevPid())t.loadImageInfo(t.prevPid()).then((function(i){e.img=$.extend(!0,{},i),t.gotoPrev(),e.switchMode()}));else{var i=t.currIndex;if(i>0){i--,"stereopair"!=this.type||this.stereoType;var o=t.items[i].pid;$("BODY").css("cursor","wait"),window.location.href="/photo-"+o+".html"}}}},{key:"requestUpdate",value:function(){this.nonOSDzoom.ticking||(window.requestAnimationFrame(this.updateTransform.bind(this)),this.nonOSDzoom.ticking=!0)}},{key:"mainphotoload",value:function(){$("#mainphoto").show(),this.iwidth=$("#mainphoto").width(),this.iheight=$("#mainphoto").height(),this.iwidth<72?window.setTimeout(this.mainphotoload.bind(this),200):($("#mainphoto").attr("width",this.iwidth),$("#mainphoto").attr("height",this.iheight),"rotation"==this.type&&this.preloadframes(),"video"==this.type&&(document.getElementById("mvideo").onended=this.stopvideo,this.updateTransform()))}},{key:"loadimage",value:function(){var e=this.img;if("normal"==this.type||"rotation"==this.type){var t=[400,800,1e3,1400,2e3,4e3,8e3,16e3,24e3,32e3,48e3],i=this.iwidth*this.nonOSDzoom.scale*window.devicePixelRatio,o=this.iheight*this.nonOSDzoom.scale*window.devicePixelRatio;if(e.pixelwidth>=e.pixelheight){for(var s=e.pixelwidth,n=t.length-1;n>=0;n--)t[n]<.9*e.pixelwidth&&t[n]>=i&&(s=t[n]);nh=Math.round(e.pixelheight*s/e.pixelwidth)}else{for(var a=e.pixelheight,r=0;r<t.count;r++)t[r]<.9*e.pixelheight&&t[r]<=o&&(a=t[r]);nw=Math.round(e.pixelwidth*a/e.pixelheight)}if(nw>this.lastsize&&!$("#seadragon").is(":visible")){this.lastsize=nw;var l="/getphoto-"+nw.toString()+"-"+nh.toString()+"-"+e.filename;$("#buttondock").html("<div class='fyi'>Loading image: "+nw+"x"+nh+" pixels...</div"),$("#mainphoto").load((function(){$("#buttondock").fadeOut("slow",(function(){$("#buttondock").html("").show()}))})).attr("src",l),this.lastimagename=l}}}},{key:"toggleoverlay",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.zoomenable){var t=this.viewers[0];this.overlay=1-this.overlay;var i=0;"stereopair"==this.type&&"mono"!=this.stereoType&&(e=!0,this.overlay=0,i=1),this.overlay?($("#bottombtnblock").show(),$("#titlebar").show(),$("#clickleft").css("opacity",1),$("#clickright").css("opacity",1),$("#photomindatlogo").css("opacity",1),$("#photomindatlogo").css("background-color","rgba(0,0,0,0.6)"),e&&($("#copyrightfloat").show(),$("#clickleft").show(),$("#clickright").show(),$("#photomindatlogo").show(),$("#photomindatlogo").show()),$("#copyrightfloat").is(":visible")&&$("#copyrightfloat").css("opacity",1),$("#seadragon:visible")&&($(".navigator").show(),t&&t.scalebar&&(t.scalebar({location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT}),t.scalebarInstance.refresh()))):($("#titlebar").hide(),i||$("#bottombtnblock").hide(),$("#copyrightfloat").is(":visible")&&$("#copyrightfloat").css("opacity",.4),i||$("#clickleft").css("opacity",0),i||$("#clickright").css("opacity",0),$("#photomindatlogo").css("opacity",.4),$("#photomindatlogo").css("background","none"),e&&($("#copyrightfloat").hide(),i||$("#clickleft").hide(),i||$("#clickright").hide(),$("#photomindatlogo").hide(),$("#photomindatlogo").hide()),$("#seadragon:visible")&&($(".navigator").hide(),t&&t.scalebar&&t.scalebar({location:OpenSeadragon.ScalebarLocation.NONE})))}}},{key:"dimButtons",value:function(e){e?(this.buttonsDimmed=1,$("#clickleft").css("opacity",.03),$("#clickright").css("opacity",.03),$("#bottombtnblock").css("opacity",.03),$("#menu-c-open").css("opacity",.03),$("#menu-3D-open").css("background-color","rgba(0, 0, 0, 0.03)"),$("#menu-3D-open").css("border","1px solid rgba(255,255,255,0.03)"),$("#menu-3D-open").css("color","rgba(204,204,204,0.06)"),$("#menu-3D-open").show(),$(".dropdown").hide(),$(".menu-annotations").hide(),$("#cb-hide-vs").prop("checked",!0),$("#menu-3D-hide-3d").text("Show interface buttons")):(this.buttonsDimmed=0,$("#clickleft").css("opacity",1),$("#clickright").css("opacity",1),$("#bottombtnblock").css("opacity",1),$("#menu-c-open").css("opacity",1),$("#menu-3D-open").css("background-color","rgba(0, 0, 0, 0.4)"),$("#menu-3D-open").css("border","1px solid rgba(255,255,255,0.6)"),$("#menu-3D-open").css("color","rgba(204,204,204,1)"),$("#menu-3D-open").show(),$(".dropdown").show(),$(".menu-annotations").show(),$("#cb-hide-vs").prop("checked",!1),$("#menu-3D-hide-3d").text("Dim interface buttons"))}},{key:"template",value:function(){if($("#"+this.options.el).is(":empty")){var e="",t=this.type,i=this.compareType,o=this.stereoType;"stereopair"!=t||"mono"!=o&&"interlace"!=o&&"anaglyph"!=o||(t="normal"),"normal"!=t&&""!=t||(e='<div id="seadragon" style="position: fixed; z-index: 0; width: 100%; height: 100%; top: 0; left: 0;"></div>'),"stereopair"==t&&("sync"!=o&&"halfwidth"!=o||(e=' <div id="sbsparent" class="sbsparent">\n                <div id="lefthalf" class="lefthalf" showmono="0">\n                    <div id="divider_L" class="divider divider_L"></div>\n                    <div class="leftpane">\n                            <div id="viewer_0" class="seadragon-viewer"></div>\n                    </div>\n                    <div id="dragbar_L" class="dragbar dragbar_L"></div>                \n                </div>\n                <div id="righthalf" class="righthalf">\n                    <div id="divider_R" class="divider divider_R"></div>             \n                    <div class="rightpane">\n                            <div id="viewer_1" class="seadragon-viewer"></div>  \n                    </div>\n                    <div id="dragbar_R" class="dragbar dragbar_R"></div>                \n                </div>\n            </div>'),"halfheight"==o&&(e='<div id="abcontainer" class="abcontainer">\n              <div id="abparent" class="abparent">\n                  <div id="upperhalf" class="abrow">\n                        <div id="viewer_0" class="seadragon-viewer"></div>               \n                  </div>\n                  <div id="lowerhalf" class="abrow">           \n                        <div id="viewer_1" class="seadragon-viewer"></div>              \n                  </div>\n              </div>\n             </div>')),"compare"==t&&("slider"==i&&(e='<div id="panel-accordion" class="panel-accordion"><div class="code-panel panel-container"><div id="viewer_0" class="slider-container"><span class="slider-handle"></span></div></div></div>'),"6x"==i&&(e='<div id="panel-accordion" class="panel-accordion"><div class="code-panel panel-container"><div id="css-box" class="CodeMirror-code"><div class="upperhalf"><div class="panel panel-0"> <div id="viewer_0" class="seadragon-viewer"></div></div><div class="panel panel-1"><div id="viewer_1" class="seadragon-viewer"></div></div><div class="panel panel-2"><div id="viewer_2" class="seadragon-viewer"></div></div></div><div class = "lowerhalf"><div class="panel panel-3"><div id="viewer_3" class="seadragon-viewer"></div></div><div class="panel panel-4"><div id="viewer_4" class="seadragon-viewer"></div></div><div class="panel panel-5"><div id="viewer_5" class="seadragon-viewer"></div></div></div></div></div></div>'),"4x"==i&&(e='<div id="panel-accordion" class="panel-accordion"><div class="code-panel panel-container"><div id="css-box" class="CodeMirror-code"><div class="upperhalf"><div class="panel panel-0"> <div id="viewer_0" class="seadragon-viewer"></div></div><div class="panel panel-1"><div id="viewer_1" class="seadragon-viewer"></div></div></div><div class = "lowerhalf"><div class="panel panel-2"><div id="viewer_2" class="seadragon-viewer"></div></div><div class="panel panel-3"><div id="viewer_3" class="seadragon-viewer"></div></div></div></div></div></div>'),"3x"==i&&(e='<div class="code-panel panel-container"><div id ="css-box" class="CodeMirror-code"><div class="panel panel-0"><div id="viewer_0" class="seadragon-viewer"></div></div><div class="panel panel-1"><div id="viewer_1" class="seadragon-viewer"></div></div><div class="panel panel-2"><div id="viewer_2" class="seadragon-viewer"></div></div></div></div>'),"2x"==i&&(e='<div class="code-panel panel-container"><div id ="css-box" class="CodeMirror-code"><div class="panel panel-0"><div id="viewer_0" class="seadragon-viewer"></div></div><div class="panel panel-1"><div id="viewer_1" class="seadragon-viewer"></div></div></div></div>'),"1x"==i&&(e='<div class="code-panel panel-container"><div id ="css-box" class="CodeMirror-code"><div class="panel panel-0"><div id="viewer_0" class="seadragon-viewer"></div></div></div></div>')),$(e).appendTo($("body").find("#"+this.options.el))}}},{key:"template_buttondock",value:function(){var e="buttondock";if($("#"+e).is(":empty")){var t="",i=this.type;if("stereopair"==i&&(t+='<button id="menu-3D-open"><div id="menu-3D-open-txt">3D</div></button>'),"rotation"==i&&(t="<div id='playvideo' class='matchrotate' style='opacity: 0.5'></div><div id='rotateon'><div id='rotateprogress'></div></div><div id='rotateoff'></div>"),"compare"==i)this.img.tileSources.length>=2&&(t+='<button id="menu-c-open"></button>');"video"==i&&(t="\n        <div id='playvideo'></div>\n        <div id='resetvideo'></div>\n        "),$(t).appendTo($("body").find("#"+e))}}},{key:"windowResizeStereo",value:function(){var e=0;$(".dragbar_L").is(":visible")&&(e=$(".dragbar_L").outerWidth()),this.stereoDragbars&&(this.offsetDragbars=this.stereoDragbars.getOffset());var t=Math.floor(($(".sbsparent").width()-3*e)/2-this.offsetDragbars);t<=0&&this.stereoDragbars&&(this.stereoDragbars.reset(),t=Math.floor(($(".sbsparent").width()-3*e)/2)),$(".leftpane").css("width",Math.floor(t)+"px"),$(".rightpane").css("width",Math.floor(t)+"px"),$(".leftpane").css("padding",Math.ceil(.007*t)+"px"),$(".rightpane").css("padding",Math.ceil(.007*t)+"px")}},{key:"windowResizeStereoHalfHeight",value:function(){var e=Math.floor($(".abcontainer").height());$(".abparent").css("height",Math.floor(2*e)+"px"),this.switchButtonsHalfHeight(!0)}},{key:"windowResizeCompare",value:function(){var e=0;if(this.compareType,"2x"==this.compareType){e=Math.floor(jQuery(".panel-container").width()/2);for(var t=0;t<2;t++)jQuery(".panel-"+t).css("width",Math.floor(e)+"px");jQuery(".panel-0").css("padding","0.5% 0.5% 0.5% 0.5%"),jQuery(".panel-2").css("padding","0.5% 0.5% 0.5% 0%")}if("3x"==this.compareType){e=Math.floor(jQuery(".panel-container").width()/3);for(var i=0;i<3;i++)jQuery(".panel-"+i).css("width",Math.floor(e)+"px");jQuery(".panel-0").css("padding","0.5% 0.5% 0.5% 0.5%"),jQuery(".panel-1").css("padding","0.5% 0.5% 0.5% 0%"),jQuery(".panel-2").css("padding","0.5% 0.5% 0.5% 0%")}if("4x"==this.compareType){e=Math.floor(jQuery(".panel-container").width()/2);for(var o=0;o<4;o++)jQuery(".panel-"+o).css("width",Math.floor(e)+"px");jQuery(".panel-0").css("padding","0.5% 0.5% 0.5% 0.5%"),jQuery(".panel-1").css("padding","0.5% 0.5% 0.5% 0%"),jQuery(".panel-2").css("padding","0%   0.5% 0.5% 0.5%"),jQuery(".panel-3").css("padding","0%   0.5% 0.5% 0%")}if("6x"==this.compareType){e=Math.floor(jQuery(".panel-container").width()/3);for(var s=0;s<6;s++)jQuery(".panel-"+s).css("width",Math.floor(e)+"px");jQuery(".panel-0").css("padding","0.5% 0.5% 0.5% 0.5%"),jQuery(".panel-1").css("padding","0.5% 0.5% 0.5% 0%"),jQuery(".panel-2").css("padding","0.5% 0.5% 0.5% 0%"),jQuery(".panel-3").css("padding","0% 0.5% 0.5% 0.5%"),jQuery(".panel-4").css("padding","0% 0.5% 0.5% 0%"),jQuery(".panel-5").css("padding","0% 0.5% 0.5% 0%")}}},{key:"initViewers",value:function(){var e=this,t=$.extend({},this.options.OSDoptions);if("normal"==this.type&&(t.showNavigator=!0,t.navigatorPosition="BOTTOM_RIGHT",t.tileSources=this.img.tileSources,this.viewers[0]=OpenSeadragon(t)),"stereopair"==this.type&&"mono"==this.stereoType&&(t.tileSources=this.img.tileSources[1],this.viewers[0]=OpenSeadragon(t)),"stereopair"==this.type&&"sync"==this.stereoType&&(this.OSDsync=new OSDsync(2,this.img.tileSources,t,"viewer_"),this.viewers=this.OSDsync.viewers),"stereopair"==this.type&&"interlace"==this.stereoType&&(t.tileSources=this.img.tileSources[0],this.viewers[0]=OpenSeadragon(t),this.viewers[0].addTiledImage({tileSource:this.img.tileSources[1],opacity:"1",compositeOperation:OpenSeadragon.interlaced("column",!1)})),"stereopair"==this.type&&"anaglyph"==this.stereoType&&(t.tileSources=this.img.tileSources[0],this.viewers[0]=OpenSeadragon(t),this.viewers[0].addTiledImage({tileSource:this.img.tileSources[1],index:1,opacity:"0",preload:!0}),setTimeout((function(){e.viewers[0].setFilterOptions({filters:[{items:[e.viewers[0].world.getItemAt(0),e.viewers[0].world.getItemAt(1)],merge:!0,mergeProcessor:OpenSeadragon.Filters.ANAGLYPH("Optimized+","RedCyan",!1)}]})}),1)),"compare"==this.type&&"slider"!=this.compareType){for(var i=0,o=this.img.tileSources.length,s=0;s<o;s++)document.getElementById("viewer_"+s)&&i++;i&&(this.OSDsync=new OSDsync(i,this.img.tileSources,t,"viewer_"),this.viewers=this.OSDsync.viewers)}"compare"==this.type&&"slider"==this.compareType&&this.initViewersCompareSlider()}},{key:"initViewers2",value:function(){"normal"==this.type&&this.initViewersNormal(),"stereopair"==this.type&&"mono"==this.stereoType&&this.initViewersStereoMono(),"stereopair"==this.type&&"sync"==this.stereoType&&this.initViewersStereoSync(),"stereopair"==this.type&&"interlace"==this.stereoType&&this.initViewersStereoInterlace(),"stereopair"==this.type&&"anaglyph"==this.stereoType&&this.initViewersStereoAnaglyph(),"compare"==this.type&&"slider"!=this.compareType&&this.initViewersCompareSync(),"compare"==this.type&&"slider"==this.compareType&&this.initViewersCompareSlider()}},{key:"initViewersNormal",value:function(){var e=this,t=$.extend({},this.options.OSDoptions);t.showNavigator=!0,t.navigatorPosition="BOTTOM_RIGHT",t.tileSources=this.img.tileSources,this.viewers[0]=OpenSeadragon(t),this.viewers[0].addHandler("open",(function(){var t=e.viewers[0],i=t.viewport;if(i.viewportToImageZoom(i.getZoom())>1){var o=i.imageToViewportZoom(1);t.viewport.zoomTo(o,null,!0),t.viewport.minZoomImageRatio=o,t.minZoomImageRatio=o}}))}},{key:"initViewersStereoMono",value:function(){var e=$.extend({},this.options.OSDoptions);e.tileSources=this.img.tileSources[1],this.viewers[0]=OpenSeadragon(e)}},{key:"initViewersStereoSync",value:function(){var e=this,t=$.extend({},this.options.OSDoptions);this.OSDsync=new OSDsync(2,this.img.tileSources,t,"viewer_",0),this.viewers=this.OSDsync.viewers;for(var i=[],o=function(t){i[t]=new Promise((function(i){e.viewers[t].addHandler("open",i,!1)}))},s=0;s<2;s++)o(s);Promise.all(i).then((function(){var t=e.viewers[1].viewport.getCenter();t.x+=0;var i=e.viewers[0].viewport.getCenter();i.x+=0,e.viewers[1].viewport.panTo(t,!0),e.viewers[0].viewport.panTo(i,!0)}))}},{key:"switchButtonsHalfWidth",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(e)$("#clickleft").css("left","calc(50% + 0.5em)"),$("#showinfo").css("left","50%"),$("#bottombtnblock").css("left","50%");else{if(0==parseInt($("#showinfo").css("left")))return;$("#clickleft").css("left","1em"),$("#showinfo").css("left","0"),$("#bottombtnblock").css("left","0")}}},{key:"switchButtonsHalfHeight",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e?($("#clickleft").css("top","calc(75% - 1em)"),$("#clickright").css("top","calc(75% - 1em)")):($("#clickleft").css("top","calc(50% - 1em)"),$("#clickright").css("top","calc(50% - 1em)"))}},{key:"initViewersStereoHalfWidth",value:function(){this.hideDragbars=!0,this.offsetDragbars=0,$("#cb-hide-db").prop("checked",!0),$(".dragbar").hide(),$(".divider").hide(),this.windowResizeStereo(),$(".sbsparent").css("transform-origin","top left"),$(".sbsparent").css("transform","scaleX(0.5)"),$(".sbsparent").width(2*$(".sbsparent").width()),$(".leftpane").width(2*$(".leftpane").width()),$(".rightpane").width(2*$(".rightpane").width()),this.initViewersStereoSync(),this.viewers[0].gestureSettingsMouse.zoomToRefPoint=!1,this.viewers[1].gestureSettingsMouse.zoomToRefPoint=!1}},{key:"initViewersStereoHalfHeight",value:function(){this.offsetDragbars=0,$("#cb-hide-db").prop("checked",!0),$(".abparent").css("transform-origin","top left"),$(".abparent").css("transform","scaleY(0.5)"),$(".abparent").height(2*$(".abparent").height()),this.windowResizeStereoHalfHeight(),this.initViewersStereoSync(),this.viewers[0].gestureSettingsMouse.zoomToRefPoint=!1,this.viewers[1].gestureSettingsMouse.zoomToRefPoint=!1}},{key:"initViewersStereoInterlace",value:function(){var e=$.extend({},this.options.OSDoptions);e.tileSources=this.img.tileSources[0],this.interlacedType||(this.interlacedType="row"),this.viewers[0]=OpenSeadragon(e),this.viewers[0].addTiledImage({tileSource:this.img.tileSources[1],opacity:"1",compositeOperation:OpenSeadragon.interlaced(this.interlacedType,!1)})}},{key:"initViewersStereoAnaglyph",value:function(){var e=this,t=$.extend({},this.options.OSDoptions);t.tileSources=this.img.tileSources[0],this.viewers[0]=OpenSeadragon(t),this.viewers[0].addTiledImage({tileSource:this.img.tileSources[1],index:1,opacity:"0",preload:!0,success:function(t){e.viewers[0].setFilterOptions({filters:[{items:[e.viewers[0].world.getItemAt(0),e.viewers[0].world.getItemAt(1)],merge:!0,mergeProcessor:OpenSeadragon.Filters.ANAGLYPH(e.anaglyphMergeType,e.anaglyphGlasses,!1)}]})}}),this.anaglyphMergeType||(this.anaglyphMergeType="Optimized+"),this.anaglyphGlasses||(this.anaglyphGlasses="RedCyan")}},{key:"initStereo3Dmenu",value:function(){var e=this;$('\n      <div id="menu-3D" class="menu-3d">\n        <div id="menu-3D-btn-cont"><div class="menu-3D-h">3D settings:</div><button id="menu-3D-close" class="menu-3D-btn"><div class="css-cross"></div></button></div>\n        <div id="menu-3D-btn2-cont">\n          <button id="menu-3D-swapLR" class="menu-3D-btn2">Swap left and right images</button>\n          <button id="menu-3D-fullscreen" class="menu-3D-btn2">Toggle fullscreen</button>\n          <button id="menu-3D-hide-3d" class="menu-3D-btn2">Dim interface buttons</button>\n        </div>\n        <div id="menu-3D-mode-cont">\n          <div class="menu-3D-text menu-3D-h">Viewing mode:</div>\n          <div class="menu-3D-text">\n              <select id="menu-3D-sel-mode" class="select-css">\n                <option value="0">Single image (2D)</option>\n                <option value="1">Side-by-side</option>\n                <option value="2">Interlaced</option>\n                <option value="3">Anaglyph</option>\n                <option value="4">Half width (3DTV)</option>  \n                <option value="5">Half height (3DTV)</option>              \n              </select>\n          </div>\n          <div id="menu-3D-mode-params" class="menu-3D-text">\n            \x3c!--<div class="menu-3D-h">Parameters:</div>--\x3e\n            <div id="menu-3D-params-sync" class="menu-3D-params">\n              <label class="cb-container">Hide dragbars\n                <input id="cb-hide-db" type="checkbox">\n                <span class="cb-checkmark"></span>\n              </label>\n            </div>\n            <div id="menu-3D-params-anaglyph" class="menu-3D-params">\n              <div class="menu-3D-text">Anaglyph type:</div>\n              <select id="menu-3D-sel-anaglyph" class="select-css">\n                <option value=\'0\'>Optimized+</option>\n                <option value=\'1\'>Optimized</option>\n                <option value=\'2\'>Color</option>\n                <option value=\'3\'>Grey</option>\n                <option value=\'4\'>True</option>\n              </select>\n              <div class="menu-3D-text">Glasses type:</div>\n              <select id="menu-3D-sel-glasses" class="select-css">\n                <option value="0">Red-Cyan</option>\n                <option value="1">Green-Magenta</option>\n              </select>\n            </div>\n            <div id="menu-3D-params-interlace" class="menu-3D-params">\n              <div class="menu-3D-text">Interlaced type:</div>\n              <select id="menu-3D-sel-interlaced" class="select-css">\n                <option value="0">Row-interlaced</option>\n                <option value="1">Column-interlaced</option>\n                <option value="2">Chessboard (DLP TV)</option>\n              </select>\n            </div>\n          </div>\n        </div>\n      </div>\n    ').appendTo($("body").find(this.el).parent()),this.hideDragbars&&$("#cb-hide-db").prop("checked",!0),this.isIOS&&$("#menu-3D-fullscreen").hide(),$("#menu-3D-sel-mode").val(this.stereoTypeValues.indexOf(this.stereoType)),$("#menu-3D-sel-anaglyph").val(this.anaglyphMergeTypeValues.indexOf(this.anaglyphMergeType)),$("#menu-3D-sel-glasses").val(this.anaglyphGlassesValues.indexOf(this.anaglyphGlasses)),$("#menu-3D-sel-interlaced").val(this.interlacedTypeValues.indexOf(this.interlacedType));var t=$("#menu-3D-sel-mode").val();$(".menu-3D-params").hide(),t>0&&$("#menu-3D-params-"+this.stereoTypeValues[t]).show(),$("#menu-3D-sel-mode").change((function(t){var i=$("#menu-3D-sel-mode option:selected").val();$(".menu-3D-params").hide();var o=e.stereoTypeValues[i];i>0&&$("#menu-3D-params-"+o).show(),"mono"!=o&&(e.lastUsedStereoType=o,$.cookie("lastUsedStereoType",o,{expires:365})),$.cookie("stereoType",o,{expires:365}),e.switchMode({type:"stereopair",stereoType:o})})),$("#menu-3D-sel-anaglyph").change((function(t){var i=$("#menu-3D-sel-anaglyph option:selected").val(),o=$("#menu-3D-sel-glasses option:selected").val();e.anaglyphMergeType=e.anaglyphMergeTypeValues[i],e.anaglyphGlasses=e.anaglyphGlassesValues[o],$.cookie("anaglyphMergeType",e.anaglyphMergeType,{expires:365}),e.switchMode({type:"stereopair",stereoType:"anaglyph"})})),$("#menu-3D-sel-glasses").change((function(t){var i=$("#menu-3D-sel-anaglyph option:selected").val(),o=$("#menu-3D-sel-glasses option:selected").val();e.anaglyphMergeType=e.anaglyphMergeTypeValues[i],e.anaglyphGlasses=e.anaglyphGlassesValues[o],$.cookie("anaglyphGlasses",e.anaglyphGlasses,{expires:365}),e.switchMode({type:"stereopair",stereoType:"anaglyph"})})),$("#menu-3D-sel-interlaced").change((function(t){var i=$("#menu-3D-sel-interlaced option:selected").val();e.interlacedType=e.interlacedTypeValues[i],$.cookie("interlacedType",e.interlacedType,{expires:365}),e.switchMode({type:"stereopair",stereoType:"interlace"})})),$("#cb-hide-db").change((function(t){$("#cb-hide-db").prop("checked")?(e.hideDragbars=1,e.offsetDragbars=0):e.hideDragbars=0,$.cookie("hideDragbars",e.hideDragbars,{expires:365}),e.switchMode({type:"stereopair",stereoType:"sync"})}));var i=new Hammer.Manager(document.getElementById("menu-3D-swapLR"));i.add(new Hammer.Tap({event:"singletap"})),i.on("singletap",(function(t){e.universalStereoSwapLR()})),screenfull.isEnabled&&screenfull.on("change",(function(){"stereopair"==e.type&&"sync"==e.stereoType&&e.windowResizeStereo(),"stereopair"==e.type&&"halfheight"==e.stereoType&&e.windowResizeStereoHalfHeight()}));var o=new Hammer.Manager(document.getElementById("menu-3D-fullscreen"));o.add(new Hammer.Tap({event:"singletap"})),o.on("singletap",(function(t){screenfull.isEnabled&&screenfull.toggle(document.getElementById("photomain")),"stereopair"==e.type&&"sync"==e.stereoType&&e.windowResizeStereo(),"stereopair"==e.type&&"halfheight"==e.stereoType&&e.windowResizeStereoHalfHeight()}));var s=new Hammer.Manager(document.getElementById("menu-3D-hide-3d"));s.add(new Hammer.Tap({event:"singletap"})),s.on("singletap",(function(t){e.buttonsDimmed?(e.dimButtons(!1),$("#menu-3D-hide-3d").text("Dim interface buttons")):(e.dimButtons(!0),$("#menu-3D-hide-3d").text("Show interface buttons"))})),$("#menu-3D-open").on("click",(function(e){$("#menu-3D").is(":visible")?($("#menu-3D").hide(),$("#menu-3D-open").show()):($("#menu-3D").show(),$("#menu-3D").hide(),$("#menu-3D").show(),$("#menu-3D-open").hide()),e.stopPropagation()})),$("#menu-3D-close").on("click",(function(e){$("#menu-3D").hide(),$("#menu-3D-open").show(),e.stopPropagation()}))}},{key:"initCompareMenu",value:function(){var e=this,t=this.img.tileSources.length;if(!(t<2)){$('\n      <div id="menu-c" class="menu-c">\n        <div id="menu-c-btn-cont">\n          <div class="menu-3D-h">Settings:</div>\n          <button id="menu-c-close" class="menu-3D-btn"><div class="css-cross"></div></button>\n        </div>\n          <div id="#menu-c-btn2-cont">\n            <label class="cb-container">Hide view selectors\n              <input id="cb-hide-vs" type="checkbox">\n              <span class="cb-checkmark"></span>\n            </label>\n          </div>\n          <div class="menu-3D-text menu-3D-h">Select layout:</div>\n          <div id="menu-c-btn-cont2">\n            <div id="menu-c-iconsline2">\n                <div id=\'compare1x\' class=\'comparebtn\'></div>\n                <div id=\'compareslider\' class=\'comparebtn\'></div>\n                <div id=\'compare2x\' class=\'comparebtn\'></div>\n            </div>\n            <div id="menu-c-iconsline1">\n                <div id=\'compare3x\' class=\'comparebtn\'></div>\n                <div id=\'compare4x\' class=\'comparebtn\'></div>\n                <div id=\'compare6x\' class=\'comparebtn\'></div>\n            </div>\n          </div>\n      </div>\n    ').appendTo($("body").find(this.el).parent()),t<5&&$("#compare6x").hide(),t<4&&$("#compare4x").hide(),t<3&&$("#compare3x, #menu-c-iconsline1").hide(),$("#compare"+this.compareType).addClass("comparebtn-current"),$("#menu-c-open").on("click",(function(e){$("#menu-c").is(":visible")?($("#menu-c").hide(),$("#menu-c-open").show()):($("#menu-c").show(),$("#menu-c-open").hide()),e.stopPropagation()})),$("#menu-c-close").on("click",(function(e){$("#menu-c").hide(),$("#menu-c-open").show(),e.stopPropagation()})),$("#cb-hide-vs").change((function(e){$("#cb-hide-vs").prop("checked")?$(".dropdown").hide():$(".dropdown").show()}));var i={};$("#menu-c").find(".comparebtn").each((function(t,o){(i=new Hammer.Manager($(o)[0])).add(new Hammer.Tap({event:"singletap"})),i.on("singletap",(function(t){$("#"+o.id).hasClass("comparebtn-current")||(e.switchMode({type:"compare",compareType:o.id.substr(7)}),$(".comparebtn-current").removeClass("comparebtn-current"),$("#"+o.id).addClass("comparebtn-current"))}))}))}}},{key:"initCompareSelectors",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=0;i=t?2:this.viewers.length;var o=this.img.tileSources.length;if(!(o<2)){for(var s=[],n=($("#photomindatlogo"),$("#titlebar")),a=n.offset().top+n.outerHeight(!0),r={},l=0,d=0;d<i;d++){s[d]='<div id="selectView'+d+'" class="dropdown"><button id="dropbtn'+d+'" class="dropbtn">'+this.compareNamesSelected[d]+'</button><div id="myDropdown'+d+'" class="dropdown-content">';for(var h=0;h<o;h++)s[d]=s[d]+'<div id="dropdown-option-'+d+"-"+h+'" class="dropdown-option">'+this.compareNames[h]+"</div>";s[d]=s[d]+"</div></div>",t||(r=$(s[d]).appendTo($("body").find(".panel-"+d)),n&&(l=r[0].offsetTop)<a&&r.css("top",l+a+"px"))}t&&(r=$(s[0]).appendTo($("body").find(".panel-container")),n&&(l=r[0].offsetTop)<a&&r.css("top",l+a+"px"),r.css("left",r.css("right")),r.css("right","auto"),r.find(".dropdown-content").css("right","auto"),r.find(".dropdown-content").css("left","0"),r=$(s[1]).appendTo($("body").find(".panel-container")),n&&(l=r[0].offsetTop)<a&&r.css("top",l+a+"px"));for(var c=function(i){for(var s=function(o){t?$("#dropdown-option-"+i+"-"+o).on("click",(function(t){e.compareNamesSelected[i]=e.compareNames[o],e.tileSourcesSelected[i]=e.img.tileSources[o],$("#dropbtn"+i).html(e.compareNamesSelected[i]),e.viewers[0].addTiledImage({tileSource:e.img.tileSources[o],replace:!0,index:i,success:function(t){0==i?(e.slider.leftImage=t.item,e.slider.leftImage.setClip(e.slider.leftRect)):(e.slider.rightImage=t.item,e.slider.rightImage.setClip(e.slider.rightRect))}}),$(".dropdown-content").hide(),t.stopPropagation()})):$("#dropdown-option-"+i+"-"+o).on("click",(function(t){e.compareNamesSelected[i]=e.compareNames[o],e.tileSourcesSelected[i]=e.img.tileSources[o],$("#dropbtn"+i).html(e.compareNamesSelected[i]),e.viewers[i].close(),e.viewers[i].open(e.tileSourcesSelected[i]),$(".dropdown-content").hide(),t.stopPropagation()}))},n=0;n<o;n++)s(n);$("#dropbtn"+i).on("click",(function(e){$("#myDropdown"+i).is(":visible")?$("#myDropdown"+i).hide():($(".dropdown-content:visible").hide(),$("#myDropdown"+i).show()),e.stopPropagation()}))},p=0;p<i;p++)c(p);this.eventListeners.windowSelectView||(this.eventListeners.windowSelectView=1,$(window).on("click",(function(e){$(".dropdown-content:visible").is(":visible")&&(e.target.matches(".dropbtn")||e.target.matches(".dropdown-option")||(e.preventDefault(),e.stopPropagation(),$(".dropdown-content").hide()))})))}}},{key:"initViewersCompareSync",value:function(){for(var e=$.extend({},this.options.OSDoptions),t=0,i=this.img.tileSources.length,o=0;o<i;o++)document.getElementById("viewer_"+o)&&t++;this.tileSourcesSelected.length<i&&(this.tileSourcesSelected=$.extend({},this.img.tileSources)),t&&(this.OSDsync=new OSDsync(t,this.tileSourcesSelected,e,"viewer_"),this.viewers=this.OSDsync.viewers,this.initCompareSelectors())}},{key:"initViewersCompareSlider",value:function(){var e=$.extend({},this.options.OSDoptions);e.id="viewer_0",this.tileSourcesSelected.length<this.img.tileSources.length&&(this.tileSourcesSelected=$.extend({},this.img.tileSources)),this.viewers[0]=OpenSeadragon(e);var t=this.viewers[0],i=$("#"+e.id),o=new OpenSeadragon.Point(i.width()/2,i.height()/2),s=null,n=null,a=new OpenSeadragon.Rect(0,0,0,0),r=new OpenSeadragon.Rect(0,0,0,0);this.slider={},this.slider.leftRect=a,this.slider.rightRect=r;var l=this;function d(){s&&n&&(a.height=s.getContentSize().y,r.height=n.getContentSize().y,h(),function(){var e=$(".slider-handle"),t=e.parents(".slider-container");l.touchInit(t[0],e[0]);var i,s,n,a,r=e.outerWidth();function d(){i=t.outerWidth(),s=t.offset().left,n=s+10,a=s+i-r-10;var o,l=e.offset().left+r/2;(o=new jQuery.Event("mousedown")).pageX=l,e.trigger(o),(o=new jQuery.Event("mousemove")).pageX=l,t.trigger(o),e.trigger("mouseup")}d(),$(window).resize(d),e.on("mousedown vmousedown",(function(l){var d=e.offset().left+r-l.pageX;function c(t){var l=t.pageX+d-r;l=Math.max(l,n);var c,p=(l=Math.min(l,a))+r/2-s,m=100*(p/i)+"%";e.css("left",m),c=p,o.x=c,h()}t.on("mousemove vmousemove",c),e.add(t).one("mouseup vmouseup",(function(e){t.unbind("mousemove vmousemove",c)})),l.preventDefault()}))}(),t.viewport.goHome(!0))}function h(){if(s=l.slider.leftImage,n=l.slider.rightImage,s&&n){var e=n.viewerElementToImageCoordinates(o).x,t=s.viewerElementToImageCoordinates(o).x;r.x=e,r.width=n.getContentSize().x-e,a.width=t,s.setClip(a),n.setClip(r)}}t.addTiledImage({tileSource:this.tileSourcesSelected[0],success:function(e){s=e.item,l.slider.leftImage=s,d()}}),t.addTiledImage({tileSource:this.tileSourcesSelected[1],success:function(e){n=e.item,l.slider.rightImage=n,d()}}),t.addHandler("animation",(function(e){h()})),this.initCompareSelectors(!0)}},{key:"universalStereoSwapLR",value:function(){var e=this.img.tileSources[0];this.img.tileSources[0]=this.img.tileSources[1],this.img.tileSources[1]=e,this.stereoOutputLeftFirst=1-this.stereoOutputLeftFirst,this.switchMode({type:this.type,stereoType:this.stereoType}),$.cookie("stereoOutputLeftFirst",this.stereoOutputLeftFirst,{expires:365})}},{key:"initScalebar",value:function(){var e=this,t=this.viewers[0];if(t){var i=OpenSeadragon.ScalebarType.MICROSCOPY;737504==this.img.pid&&(i=OpenSeadragon.ScalebarType.CIRCLE),t.scalebar({container:document.getElementById(this.options.el),type:i,pixelsPerMeter:this.img.scalebarScale,minWidth:"110px",location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,xOffset:5,yOffset:10,stayInsideImage:!1,color:"#ccc",fontColor:"#d6d6d6",backgroundColor:"rgba(0, 0, 0, 0.5)",fontSize:"14px",barThickness:2}),t.scalebarInstance.mouseTracker.dblClickHandler=function(){this.moved||this.manualSize?(this.moved=0,this.manualSize=0,this.refresh()):(this.type!=OpenSeadragon.ScalebarType.CIRCLE?(this.type=OpenSeadragon.ScalebarType.CIRCLE,this.backgroundColor="rgba(0,0,0,0.3)",this.setDrawScalebarFunction(this.type)):(this.type=OpenSeadragon.ScalebarType.MICROSCOPY,this.backgroundColor="rgba(0,0,0,0.5)",this.setDrawScalebarFunction(this.type),this.refresh(),this.setWidthToFillContainer()),this.refresh())}.bind(t.scalebarInstance),$(window).ready((function(){var t=$("#photomain"),i=$(".OSD-scalebar");e.touchInit(t[0],i[0])}))}}},{key:"showinfo",value:function(){$("#bottombtnblock").hide(),$("#copyrightfloat").hide(),this.viewers[0]&&this.viewers[0].scalebar&&this.viewers[0].scalebar({location:OpenSeadragon.ScalebarLocation.NONE}),$("#photoinfobox").slideDown("fast"),this.zoomenable=0,this.mc=null}},{key:"hideinfo",value:function(){this.zoomenable=1,$("#photoinfobox").slideUp("fast"),this.overlay&&$("#copyrightfloat").show(),this.viewers[0]&&this.viewers[0].scalebar&&this.viewers[0].scalebar({location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT}),$("#bottombtnblock").show()}},{key:"is_touch_device",value:function(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}},{key:"darker",value:function(){this.glev--,this.glev<0&&(this.glev=0),this.setbg(),$.cookie("picgs",this.glev,{expires:365})}},{key:"lighter",value:function(){this.glev++,this.glev>15&&(this.glev=15),this.setbg(),$.cookie("picgs",this.glev,{expires:365})}},{key:"setbg",value:function(){var e="00"+(this.glev+16*this.glev+256*this.glev).toString(16);$("BODY").css("background-color","#"+e.slice(-3))}},{key:"togglehelp",value:function(){$("#helpbox").fadeToggle(100)}},{key:"playRotation",value:function(){this.helpshow&&($("#rotatehelp").fadeOut(250),this.helpshow=0),this.autoplay?this.stopRotation():($("#playvideo").css("background","url(/images/pause.png)").css("background-size","2em 2em").css("background-position","0.15em 0.15em").css("background-repeat","no-repeat"),this.autoplay=1,this.myInterval=setInterval(this.ffd.bind(this),100))}},{key:"stopRotation",value:function(){$("#playvideo").css("background","url(/images/play.png)").css("background-size","2em 2em").css("background-position","0.2em 0.2em").css("background-repeat","no-repeat"),this.autoplay=0,clearInterval(this.myInterval)}},{key:"resetvideo",value:function(){document.getElementById("mvideo").currentTime=0,this.stopvideo()}},{key:"rewind",value:function(){var e=document.getElementById("mvideo"),t=e.currentTime;e.currentTime=t-10,t-10<=0&&this.stopvideo()}},{key:"fastforward",value:function(){var e=document.getElementById("mvideo"),t=e.currentTime;e.currentTime=t+10,t+10>=e.duration&&this.stopvideo()}},{key:"playvideo",value:function(){var e=document.getElementById("mvideo");e.paused?($("#playvideo").css("background","url(/images/pause.png)").css("background-size","2em 2em").css("background-position","0.15em 0.15em").css("background-repeat","no-repeat"),e.play()):this.stopvideo()}},{key:"stopvideo",value:function(){var e=document.getElementById("mvideo");$("#playvideo").css("background","url(/images/play.png)").css("background-size","2em 2em").css("background-position","0.2em 0.2em").css("background-repeat","no-repeat"),e.pause()}},{key:"fill",value:function(e){var t=$(window).width(),i=$(window).height(),o=t/i,s=this.iwidth,n=s/this.iheight;this.nonOSDzoom.scale=0==e&&n>o||1==e&&n<o?t/s:i/this.iheight;var a=this.nonOSDzoom;if(a.LAST_X=a.START_X=a.LAST_Y=a.START_Y=a.xxx=a.yyy=0,this.requestUpdate(),this.viewers[0]){var r=!1;0==e?this.viewers[0].viewport.goHome(!0):(r=this.viewers[0].viewport.homeFillsViewer,this.viewers[0].viewport.homeFillsViewer=!0,this.viewers[0].viewport.goHome(!0),this.viewers[0].viewport.homeFillsViewer=r)}else this.img.frames<3&&this.loadimage()}}]),e}();